filter {
        grok {
                match => { "message" => "%{EXIM_DATE:exim_date} pid %{EXIM_PID:exim_pid}" }
        }
        date {
                locale => "en"
                match => [ "exim_date", "yyyy-MM-dd HH:mm:ss" ]
        }
        grok {
                patterns_dir => "/etc/logstash/patterns.d"
                match => { "message" => "SMTP connection %{EXIM_REMOTE_HOST} %{GREEDYDATA:exim_conn_info}" }
                add_field => [ "exim_msg_state", "connection" ]
        }
        grok {
                patterns_dir => "/etc/logstash/patterns.d"
                match => { "message" => "%{EXIM_MSGID:exim_messageid} Completed" }
                add_field => [ "exim_msg_state", "completed" ]
        }
        grok {
                patterns_dir => "/etc/logstash/patterns.d"
                match => { "message" => "(?<exim_error>rejected RCPT) .*?%{EXIM_MAIL:exim_mail_to}.?: %{GREEDYDATA:exim_error_info}" }
                add_field => [ "exim_msg_state", "error" ]
        }
        grok {
                patterns_dir => "/etc/logstash/patterns.d"
                match => { "message" => "%{EXIM_MSGID:exim_messageid} DKIM: %{GREEDYDATA:exim_dkim_status}" }
                add_field => [ "exim_msg_state", "dkim" ]
        }
        grok {
                patterns_dir => "/etc/logstash/patterns.d"
                match => { "message" => "%{EXIM_RECEIVED}" }
                add_field => [ "exim_msg_state", "receiver" ]
        }
        grok {
                patterns_dir => "/etc/logstash/patterns.d"
                match => { "message" => "%{EXIM_PROCESS}" }
                add_field => [ "exim_msg_state", "process" ]
        }
        grok {
                patterns_dir => "/etc/logstash/patterns.d"
                match => { "message" => "%{EXIM_MSGID:exim_messageid} Sender identification %{EXIM_SENDER_IDENTIFICATION:sender_identification}" }
                add_field => [ "exim_msg_state", "identification" ]
        }
        grok {
                patterns_dir => "/etc/logstash/patterns.d"
                match => { "message" => "%{EXIM_MSGID:exim_messageid} SMTP connection identification (D=%{DOMAIN}) (O=%{EXIM_MAIL}) (E=%{EXIM_MAIL:exim_forward}) " }
                add_field => [ "exim_msg_state", "forward" ]
        }
        grok {
                patterns_dir => "/etc/logstash/patterns.d"
                match => { "message" => "%{EXIM_DELIVERY_LOCAL:exim_delivery_local}" }
                add_field => [ "exim_msg_state", "delivered_local" ]
        }
        grok {
                patterns_dir => "/etc/logstash/patterns.d"
                match => { "message" => "%{EXIM_DELIVERY_OUT:exim_delivery_out}" }
                add_field => [ "exim_msg_state", "delivered_out" ]
        }
        grok {
                patterns_dir => "/etc/logstash/patterns.d"
                match => { "message" => "%{EXIM_DELIVERY_MAILMAN:exim_delivery_mailman}" }
                add_field => [ "exim_msg_state", "delivered_mailman" ]
        }
        grok {
                patterns_dir => "/etc/logstash/patterns.d"
                match => { "message" => "%{EXIM_DELIVERY_VIA_RELAY:exim_delivery_via_relay}" }
                add_field => [ "exim_msg_state", "delivered_via_relay" ]
        }
        grok {
                patterns_dir => "/etc/logstash/patterns.d"
                match => { "message" => "%{EXIM_DELIVERY_BOXTRAPPER:exim_delivery_boxtrapper}" }
                add_field => [ "exim_msg_state", "delivered_boxtrapper" ]
        }
        grok {
                patterns_dir => "/etc/logstash/patterns.d"
                match => { "message" => "%{EXIM_DELIVERY_ERROR:exim_delivery_error}" }
                add_field => [ "exim_msg_state", "failed" ]
        }
        grok {
                patterns_dir => "/etc/logstash/patterns.d"
                match => { "message" => "%{EXIM_DELIVERY_DEFER_A}" }
                match => { "message" => "%{EXIM_DELIVERY_DEFER_B}" }
                match => { "message" => "%{EXIM_DELIVERY_DEFER_C}" }
                add_field => [ "exim_msg_state", "defer" ]
        }

        #geoip {
        #    source      => "exim_remote_ip"
        #    target      => "geoip"
        #    database    => "/etc/logstash/GeoLite2-City.mmdb"
        #    add_field   => [ "[location]", "%{[geoip][longitude]}" ]
        #    add_field   => [ "[location]", "%{[geoip][latitude]}"  ]
        #}

        mutate {
                convert => {
        "exim_msg_size" => "integer"
                }
                remove_tag => [ "_grokparsefailure" ]
        }
}
